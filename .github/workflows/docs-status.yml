name: Documentation Status

on:
  pull_request:
    branches: [main]
    paths:
      - 'docs/**'
      - '.readthedocs.yaml'
  schedule:
    # Run weekly to check for broken links
    - cron: '0 0 * * 0'  # Every Sunday at midnight
  workflow_dispatch:

jobs:
  status-check:
    name: Documentation Health Check
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for sphinx-last-updated-by-git
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        working-directory: docs
        run: |
          make install
      
      - name: Count documentation files
        id: count
        run: |
          rst_count=$(find docs -name "*.rst" -type f | wc -l)
          md_count=$(find docs -name "*.md" -type f | wc -l)
          total=$((rst_count + md_count))
          
          echo "rst_files=$rst_count" >> $GITHUB_OUTPUT
          echo "md_files=$md_count" >> $GITHUB_OUTPUT
          echo "total_files=$total" >> $GITHUB_OUTPUT
          
          echo "ðŸ“Š Documentation Statistics:"
          echo "  - RST files: $rst_count"
          echo "  - MD files: $md_count"
          echo "  - Total: $total"
      
      - name: Check build time
        id: buildtime
        run: |
          start_time=$(date +%s)
          
          cd docs
          make html
          
          end_time=$(date +%s)
          build_seconds=$((end_time - start_time))
          
          echo "build_time=$build_seconds" >> $GITHUB_OUTPUT
          echo "â±ï¸ Build time: ${build_seconds}s"
      
      - name: Calculate documentation size
        id: size
        run: |
          size_kb=$(du -sk docs/_build/ | cut -f1)
          size_mb=$((size_kb / 1024))
          
          echo "size_mb=$size_mb" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Build size: ${size_mb}MB"
      
      - name: Generate status report
        run: |
          cat << EOF > /tmp/docs-status.md
          ## ðŸ“– Documentation Status Report
          
          **Generated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          ### ðŸ“Š Statistics
          - **Total files:** ${{ steps.count.outputs.total_files }}
            - RST: ${{ steps.count.outputs.rst_files }}
            - Markdown: ${{ steps.count.outputs.md_files }}
          - **Build time:** ${{ steps.buildtime.outputs.build_time }}s
          - **Build size:** ${{ steps.size.outputs.size_mb }}MB
          
          ### âœ… Status
          - Build: Successful
          - Format: Sphinx with Canonical theme
          - Framework: DiÃ¡taxis
          
          EOF
          
          cat /tmp/docs-status.md
      
      - name: Upload status report
        uses: actions/upload-artifact@v4
        with:
          name: documentation-status-report
          path: /tmp/docs-status.md
          retention-days: 30
      
      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('/tmp/docs-status.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });
